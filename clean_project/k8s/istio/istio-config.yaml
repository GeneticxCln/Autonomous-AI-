# Istio Service Mesh Configuration
# Advanced networking, security, and observability

apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: agent-system-istio
  namespace: istio-system
spec:
  # Global mesh configuration
  meshConfig:
    # Default config for all proxies
    defaultConfig:
      # Tracing configuration
      tracing:
        sampling: 100.0  # 100% sampling for development
        max_path_length: 256
      # Proxy metadata
      proxyMetadata:
        ISTIO_META_DNS_CAPTURE: "true"
        ISTIO_META_DNS_AUTO_ALLOCATE: "true"
      # Hold application until proxy is ready
      holdApplicationUntilProxyStarts: true
    # Access logging configuration
    accessLogFile: /dev/stdout
    accessLogFormat: |
      [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
      %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
      %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
      "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"
      %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS%
      %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%

  # Component configuration
  components:
    # Ingress Gateway
    ingressGateways:
      - name: istio-ingressgateway
        enabled: true
        k8s:
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 2000m
              memory: 1024Mi
          service:
            type: LoadBalancer
            ports:
              - port: 15021
                targetPort: 15021
                name: status-port
              - port: 80
                targetPort: 8080
                name: http2
              - port: 443
                targetPort: 8443
                name: https
              - port: 31400
                targetPort: 31400
                name: tcp
    # Egress Gateway
    egressGateways:
      - name: istio-egressgateway
        enabled: true
        k8s:
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

  # Global values
  values:
    # Pilot (Istiod) configuration
    pilot:
      autoscaleEnabled: true
      autoscaleMin: 1
      autoscaleMax: 5
      resources:
        requests:
          cpu: 500m
          memory: 2048Mi
        limits:
          cpu: 5000m
          memory: 4096Mi
      # Enable config analysis
      configAnalysis: true

    # Proxy configuration
    global:
      # Multi-cluster support
      multiCluster:
        clusterName: agent-system-cluster
      # Network configuration
      network: agent-system-network
      # Mesh ID for multi-cluster
      meshID: agent-system-mesh
      # mtls configuration
      mtls:
        auto: true

    # Proxy configuration
    proxy:
      # Resource limits
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 2000m
          memory: 1024Mi
      # Logging level
      logLevel: info
      # Component log level
      componentLogLevel: "misc:info"
      # Image pull policy
      imagePullPolicy: IfNotPresent

    # Gateway configuration
    gateways:
      istio-ingressgateway:
        injectionTemplate: gateway
      istio-egressgateway:
        injectionTemplate: gateway

    # Security configuration
    security:
      # Workload certificate configuration
      workloadCertTtl: 21600h  # 90 days
      # Certificate rotation
      selfSigned: true

    # Telemetry configuration
    telemetry:
      v2:
        # Prometheus telemetry
        prometheus:
          enabled: true
          configOverride:
            metric_relabeling_configs:
              - source_labels: [__name__]
                regex: 'istio_.*'
                target_label: '__tmp_istio_metric'
              - source_labels: [__tmp_istio_metric]
                regex: 'istio_requests_total'
                target_label: '__keep'
                replacement: 'true'
        # Stackdriver telemetry (optional)
        stackdriver:
          enabled: false
